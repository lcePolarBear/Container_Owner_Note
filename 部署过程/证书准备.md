## 准备证书

__各组件所需证书__
```
etcd & flannel  ca.pem | server.pem | server-key.pem
kube-apiserver  ca.pem | server.pem | server-key.pem
kubelet         ca.pem | ca-kay.pem 
kube-proxy      ca.pem | kube-proxy.pem | kube-proxy-key.pem
kubectl         ca.pem | admin.pem | admin-key.pem
```
__生成证书__
* 用 openssl 来完成 ssl 的认证非常麻烦 我们用 cfssl 来完成
* 获取 cfssl
    ```
    wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
    wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
    wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
    ```
    - cfssl 用于生成证书   
        cfssljson 用于将 json 文本导入证书  
        cfssl-certinfo 查看证书信息
* 赋予执行权限
    ```
    chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
    ```
* 加入到可直接执行命令中
    ```
    mv cfssl_linux-amd64 /usr/local/bin/cfssl
    mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
    mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo
    ```
- etcd 生成所需证书 
    - 生成 ca 机构的属性
    ```
    cat > ca-config.json <<EOF
    {
    "signing": {
        "default": {
        "expiry": "87600h"
        },
        "profiles": {
        "www": {
            "expiry": "87600h",
            "usages": [
                "signing",
                "key encipherment",
                "server auth",
                "client auth"
                    ]
                }
            }
        }
    }
    EOF
    ```
    - 生成 ca 请求
    ```
    cat > ca-csr.json <<EOF
    {
        "CN": "etcd CA",
        "key": {
            "algo": "rsa",
            "size": 2048
        },
        "names": [
            {
                "C": "CN",
                "L": "Beijing",
                "ST": "Beijing"
            }
        ]
    }
    EOF
    ```
    - 生成 ca 根证书 生成 ca ca-key
    ```
    cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
    ```
    - 配置 etcd 证书的域名
    ```
    cat > server-csr.json <<EOF
    {
        "CN": "etcd",
        "hosts": [
        "192.168.10.110",
        "192.168.10.111",
        "192.168.10.112"
        ],
        "key": {
            "algo": "rsa",
            "size": 2048
        },
        "names": [
            {
                "C": "CN",
                "L": "BeiJing",
                "ST": "BeiJing"
            }
        ]
    }
    EOF
    ```
    - 生成 etcd 证书
    ```
    cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server
    ```
* 自动化脚本 [create_etcd_pem.sh](https://github.com/lcePolarBear/Kubernetes_Basic_Config_Note/blob/master/config-files/create_etcd_pem.sh) 生成以上 pem 私钥文件
    - 注意要修改其中的群集各机 ip 地址！