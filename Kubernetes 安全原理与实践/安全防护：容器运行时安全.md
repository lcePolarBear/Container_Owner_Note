# å®‰å…¨ä»¿ä½›ï¼šå®¹å™¨è¿è¡Œæ—¶å®‰å…¨
<aside>
ğŸ’¡ å®¹å™¨è¿è¡Œæ—¶å®‰å…¨æŒ‡çš„æ˜¯å¯¹å®¹å™¨è¿›è¡Œå®‰å…¨é˜²æŠ¤ï¼Œåˆ†ä¸¤ä¸ªæ–¹é¢ï¼šäº‹å‰é˜²å¾¡å’Œäº‹åå¤„ç†

</aside>

## äº‹å‰é˜²å¾¡

**æ‰€è°“çš„äº‹å‰é˜²å¾¡ï¼Œä¸»è¦æ˜¯æŒ‡é€šè¿‡ä¸€äº›æ‰‹æ®µæ¥å°½å¯èƒ½çš„é˜»æ­¢ä¸€äº›æ”»å‡»è¡Œä¸ºçš„å‘ç”Ÿã€‚**

### ä½¿ç”¨é root ç”¨æˆ·

é»˜è®¤æƒ…å†µä¸‹å®¹å™¨å†…æ˜¯ä½¿ç”¨ root ç”¨æˆ·è¿›è¡Œæ“ä½œçš„ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸å°çš„å®‰å…¨éšæ‚£ï¼Œç”±äºå®¹å™¨æŠ€æœ¯æ˜¯å…±äº«åŒä¸€ä¸ªä¸»æœºä¸Šçš„æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ‰€ä»¥ä¸€æ—¦è¿™äº›å®¹å™¨è¢«æ”»å‡»è€…åˆ©ç”¨ï¼Œåˆ™å¯èƒ½å¯¹ä¸»æœºä¸Šçš„å…¶ä»– å®¹å™¨å®ä¾‹æˆ–è€…ä¸»æœºå®‰å…¨é€ æˆå¨èƒã€‚æœ€å…¸å‹çš„æ˜¯ CVE-2019-5736 å®¹å™¨é€ƒé€¸æ¼æ´ã€‚

ä¸ºäº†è§„é¿æ­¤ç±»é—®é¢˜ï¼Œæˆ‘ä»¬çš„ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯**åœ¨å®¹å™¨å†…ä½¿ç”¨é root ç”¨æˆ·**ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰ä¸¤ç§å®é™…çš„æ“ä½œæ–¹å¼ã€‚

**ç¬¬ä¸€ç§æ“ä½œæ–¹å¼ï¼Œåœ¨æ„å»ºé•œåƒæ—¶å°±å°†ç”¨æˆ·åˆ‡æ¢ä¸ºé root ç”¨æˆ·**

æ¯”å¦‚ï¼Œä½¿ç”¨å¦‚ä¸‹çš„ Dockerfileï¼Œåˆ›å»ºä¸€ä¸ªé root çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œç„¶åä½¿ç”¨Â `USER`Â æŒ‡ä»¤æ¥å£°æ˜è¿è¡Œæ—¶çš„ç”¨æˆ·ã€‚

```docker
FROM alpine

RUN addgroup -S -g 1000 moelove && adduser -S -G moelove -u 1000 moelove

USER moelove
```

**ç¬¬äºŒç§æ“ä½œæ–¹å¼ï¼Œåœ¨å¯åŠ¨å®¹å™¨æ—¶ï¼ŒæŒ‡å®šä½¿ç”¨é root ç”¨æˆ·æ¥å¯åŠ¨å®¹å™¨**

Docker ä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆç®€å•çš„åŠæ³•ï¼Œå¯ä»¥å…è®¸æˆ‘ä»¬åœ¨å¯åŠ¨å®¹å™¨æ—¶å€™ï¼Œé€šè¿‡Â `-user`Â æ¥æŒ‡å®šå®¹å™¨å†…çš„ç”¨æˆ·èº«ä»½ã€‚

```bash
docker run --rm -it --user 1000:1000  alpine
```

åœ¨ Kubernetes ä¸­å…¶å®ä¹Ÿæœ‰ç±»ä¼¼çš„ä½¿ç”¨æ–¹å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ Pod çš„Â `securityContext`Â ä¸­æŒ‡å®šÂ `runAsUser`Â ç­‰æ–¹å¼æ¥æŒ‡å®šå…¶è¿è¡Œèº«ä»½ã€‚

### ç²¾ç»†åŒ–æƒé™æ§åˆ¶

é€šè¿‡ Linux çš„ capability èƒ½åŠ›å¯ä»¥æ›´åŠ ç²¾ç»†åŒ–çš„æ§åˆ¶å®¹å™¨çš„æƒé™èƒ½åŠ›ã€‚

å°†å†…æ ¸å‚æ•° `net.ipv4.ip_unprivileged_port_start` è°ƒæ•´ä¸º Linux é»˜è®¤çš„ 1024

```bash
docker run  --sysctl net.ipv4.ip_unprivileged_port_start=1024 alpine:non-root
```

åˆ é™¤ `net_bind_service` è¿™ä¸ª capability

```bash
docker run --cap-drop="net_bind_service" --sysctl net.ipv4.ip_unprivileged_port_start=1024 alpine
```

ç›´æ¥Â `-cap-drop="ALL"`Â å»æ‰æ‰€æœ‰çš„ capabilities, ç„¶åé€šè¿‡Â `-cap-add`Â ä»…å¢åŠ Â `net_bind_service`Â æ¥ä½¿ç”¨ã€‚

```bash
docker run --cap-drop="ALL" --cap-add="net_bind_service" --sysctl net.ipv4.ip_unprivileged_port_start=1024 alpine
```

åœ¨ Kubernetes ä¸­å…¶å®ä¹Ÿæœ‰ç±»ä¼¼çš„ä½¿ç”¨æ–¹å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ Pod çš„Â `securityContext`Â ä¸­æŒ‡å®šÂ `capabilities`Â çš„æ–¹å¼æ¥æ§åˆ¶å…¶èƒ½åŠ›ã€‚

## äº‹åå¤„ç†

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¦‚æœæˆ‘ä»¬é­å—äº†æ”»å‡»ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ”»å‡»è€…æˆ–è€…æ¶æ„ç¨‹åºéƒ½ä¼šäº§ç”Ÿä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§è¿›è¡Œç›¸å…³çš„å¨èƒæ£€æµ‹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª CNCF å­µåŒ–çº§åˆ«çš„é¡¹ç›®Â [Falco](https://falco.org/)Â æ¥è¿›è¡Œè¾…åŠ©ã€‚**Falco æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿè¿è¡Œæ—¶å®‰å…¨çš„é¡¹ç›®ï¼Œä¹Ÿæ˜¯å½“å‰æœ€æµè¡Œï¼Œå¹¶ä¸”å‡ ä¹æˆä¸ºäº‘åŸç”Ÿæ—¶ä»£ä¸‹äº‹å®ä¸Šçš„ Kubernetes å¨èƒæ£€æµ‹å¼•æ“**ã€‚

Falco æ˜¯é€šè¿‡æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œå®‰å…¨æ£€æµ‹çš„ã€‚å®ƒä¼šæ ¹æ®å½“å‰å·²é…ç½®å¥½çš„è§„åˆ™åˆ—è¡¨è¿›è¡Œåç»­çš„æ“ä½œï¼Œæ¯”å¦‚æ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œè¾“å‡ºæ—¥å¿—æˆ–è€…è°ƒç”¨å…¶ä»–çš„æ¥å£ç­‰ã€‚

### Falco å®‰è£…

CentOS

```bash
# ä¿¡ä»»falcosecurity GPG key
rpm --import https://falco.org/repo/falcosecurity-3672BA8F.asc

é…ç½®yumä»“åº“
curl -s -o /etc/yum.repos.d/falcosecurity.repo https://falco.org/repo/falcosecurity-rpm.repo
yum install epel-release -y
yum update

# å®‰è£… kernel headers
yum -y install kernel-devel-$(uname -r)

# å®‰è£… falco
yum install falco -y

# å®‰è£…é©±åŠ¨
falco-driver-loader module

# å¯åŠ¨ falco
systemctl start falco
systemctl enable falco
```

Ubuntu

```bash
sudo -i

# æ·»åŠ æºä»“åº“
curl -s https://falco.org/repo/falcosecurity-3672BA8F.asc | apt-key add -
echo "deb https://download.falco.org/packages/deb stable main" | tee -a /etc/apt/sources.list.d/falcosecurity.list
apt-get update -y

# å®‰è£…å‰ç½®ä¾èµ–
apt-get install -y linux-headers-$(uname -r)

# å®‰è£… Falco
apt-get install -y falco

# å®‰è£…é©±åŠ¨
falco-driver-loader module
```

### Falco ä½¿ç”¨

é»˜è®¤æƒ…å†µä¸‹ falco ä¼šä½¿ç”¨Â `/etc/falco/falco.yaml`Â ä½œä¸ºè‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒä¹Ÿä¼šå®šä¹‰ Falco å¯ä»¥ä½¿ç”¨çš„ rules åˆ—è¡¨ï¼Œå…·ä½“å¦‚ä¸‹

```yaml
rules_file:
  - /etc/falco/falco_rules.yaml
  - /etc/falco/falco_rules.local.yaml
  - /etc/falco/k8s_audit_rules.yaml
  - /etc/falco/rules.d
```

åœ¨ Falco çš„é»˜è®¤é…ç½®Â `/etc/falco/falco_rules.yaml`Â ä¸­åŒ…å«äº†ä¸€äº›æ¯”è¾ƒå¸¸è§„çš„ rulesï¼Œæˆ‘ä»¬ä»¥å…¶ä¸­æœ€å®ç”¨çš„ä¸€æ¡ä¸ºä¾‹

```yaml
- rule: Terminal shell in container
  desc: A shell was used as the entrypoint/exec point into a container with an attached terminal.
  condition: >
    spawned_process and container
    and shell_procs and proc.tty != 0
    and container_entrypoint
    and not user_expected_terminal_shell_in_container_conditions
  output: >
    A shell was spawned in a container with an attached terminal (user=%user.name user_loginuid=%user.loginuid %container.info
    shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty container_id=%container.id image=%container.image.repository)
  priority: NOTICE
  tags: [container, shell, mitre_execution]
```

è¿™æ¡è§„åˆ™çš„å«ä¹‰æ˜¯ï¼Œå¦‚æœåœ¨å®¹å™¨ä¸­æ–°æ‰“å¼€äº†ä¸€ä¸ª shell å°±ä¼šè¾“å‡ºä¸€æ¡æ—¥å¿—ã€‚å…·ä½“è€Œè¨€ï¼Œå°±æ˜¯å¦‚æœæœ‰ç”¨æˆ·æ‰§è¡Œäº†Â `docker exec`Â è¿›å…¥åˆ°å®¹å™¨ä¸­æ—¶ï¼Œå°±ä¼šè®°å½•æ—¥å¿—ã€‚

æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼Œä½¿ç”¨Â `redis:alpine`Â çš„é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œç„¶åÂ `docker exec`Â è¿›å…¥æ­¤å®¹å™¨å†…ã€‚

```yaml
[root@sddk ~]# docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                       PORTS                                                                                                                     NAMES
3ab50d84baa6   redis:alpine                         "docker-entrypoint.sâ€¦"   5 minutes ago   Up 5 minutes                 6379/tcp                                                                                                                  competent_lumiere                                                                                                     competent_lumiere

[root@sddk ~]# docker exec -it $(docker ps -ql) sh
```

æ­¤æ—¶ï¼ŒæŸ¥çœ‹ Falco çš„æ—¥å¿—ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡º

```yaml
[root@sddk ~]# journalctl -fu falco
2æœˆ 03 21:00:39 sddk falco[15784]: 21:00:39.032807070: Notice A shell was spawned in a container with an attached terminal (user=root user_loginuid=-1 competent_lumiere (id=3ab50d84baa6) shell=sh parent=runc cmdline=sh terminal=34816 container_id=3ab50d84baa6 image=redis)
```

å¯ä»¥çœ‹åˆ°ï¼ŒåŒ…æ‹¬æ“ä½œç”¨æˆ·ã€å®¹å™¨åç§°å’Œ ID ä»¥åŠå¯¹åº”çš„æ“ä½œå‘½ä»¤éƒ½è¢«è®°å½•äº†ä¸‹æ¥ã€‚

## æ€»ç»“

åœ¨å®¹å™¨è¿è¡Œæ—¶å®‰å…¨çš„æ–¹é¢ï¼Œæˆ‘ä»¬ä¸»è¦è¿›è¡Œäº†ä¸¤æ–¹é¢çš„ä»‹ç»ï¼šäº‹å‰é˜²å¾¡å’Œäº‹åå¤„ç†ã€‚

- **äº‹å‰é˜²å¾¡**æ›´å¤šçš„å€¾å‘äºæ˜¯ä¸€ç§æœ€ä½³å®è·µï¼Œä½ å¯ä»¥é¿å…åœ¨å®¹å™¨å†…ä½¿ç”¨ root ç”¨æˆ·ï¼Œæˆ–è€…åˆ©ç”¨ Linux å†…æ ¸çš„ capabilities å¯¹å®¹å™¨æƒé™è¿›è¡Œç²¾ç»†åŒ–çš„æ§åˆ¶ã€‚
- **äº‹åå¤„ç†**ä¸»è¦æ˜¯ä¸ºä½ ä»‹ç»äº†ä¸€ä¸ªå«åš Falco çš„é¡¹ç›®ï¼Œå®ƒæ˜¯ç”± sysdig å…¬å¸å¼€æºå¹¶æèµ ç»™ CNCF çš„ã€‚Falco å¯ä»¥é€šè¿‡æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆç›¸å¯¹åº”çš„å®‰å…¨æ£€æµ‹ã€‚åŒæ—¶ï¼ŒFalco ä¸ä»…å¯ä»¥ç›´æ¥è¿è¡Œåœ¨ä¸»æœºä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®¹å™¨è¿è¡Œæˆ–è€…éƒ¨ç½²åˆ° Kubernetes ä¸­ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨ä¸­ï¼Œæ›´å¤šçš„è¿˜æ˜¯åœ¨é»˜è®¤æºå¸¦çš„ 60+ ç§è§„åˆ™çš„åŸºç¡€ä¸Šï¼ŒæŒ‰ç…§è‡ªå·±çš„å®é™…éœ€æ±‚è¿›è¡Œç›¸åº”çš„ä¿®æ”¹å’Œè°ƒæ•´å³å¯ã€‚