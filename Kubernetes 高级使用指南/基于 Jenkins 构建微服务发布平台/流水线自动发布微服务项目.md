# 流水线自动发布微服务项目
### 将微服务项目自动化部署到 kubernetes 需要考虑的需求
- 尽量完全自动化部署，无需过多人工干预
- 可以选择升级某个、某些微服务
- 在部署、升级微服务时，可对微服务某些特性做配置，例如命名空间、副本数量
### Pipeline 编写思路
- 在微服务架构中，会涉及几个、几十个微服务，如果每个服务都创建一个 item ，势必给运维维护成本增加很大，因此需要编写一个通用 Pipeline 脚本，将这些微服务部署差异化部分使用 Jenkins 参数化，人工交互确认发布的微服务、环境配置等。
- 但这只是解决用户交互层面，在 kubernetes 实际部署项目用 YAML 创建对应资源，现在问题是如何接收用户交互参数，自动化生成 YAML 文件，这就会用到 Helm 完成 YAML 文件高效复用和微服务部署。
### 编写 Pipeline 流水线脚本
1. 将 harbor 认证和 gitlab 认证保存到 Jenkins 凭据
    - 管理 Jenkins > 安全 > 管理凭据 > Jnekins > 添加凭据 > Username with password
    - 分别添加连接 gitlab 和 harbor 的用户名到 Jenkins 凭据，然后获取该凭据 ID 替换到脚本中 docker_registry_auth 和 git_auth 变量的值。
2. 将 kubeconfig 存储在 Jenkins ，用于 slave 镜像里 kubectl 连接 kubernetes 集群
    - 管理 Jenkins > Managed files > Add a new Config > Custom file -> Content （字段内容是 kubeconfig ）
    - 将 kubectl 、 helm 工具封装到 Slave 镜像中，并通过 Config File Provider 插件存储连接 kubernetes 集群的 kubeconfig 认证文件，然后挂载到 Slave 容器中，这样就能用 `kubectl apply deploy.yaml --kubeconfig=config` 管理 kubernetes 应用了，为提高安全性， kubeconfig 文件可分配权限。
### 流水线脚本与源代码一起版本管理
- Jenkinsfile文件建议与源代码一起版本管理，实现流水线即代码（ Pipeline as Code ）， Jenkins 从 Git 仓库中读取 Jenkinsfile
    - 自动为所有分支创建流水线脚本
    - 方便流水线代码复查、追踪、迭代
    - 可被项目成员查看和编辑