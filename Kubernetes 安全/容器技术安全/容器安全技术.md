# å®¹å™¨å®‰å…¨æŠ€æœ¯

<aside>
ğŸ’¡ å®‰å…¨é—®é¢˜æ ¹æœ¬ä¸Šæ¥è¯´æ˜¯ä¸€ä¸ªåšå¼ˆçš„è¿‡ç¨‹ï¼Œæ”»å‡»æ‰‹æ®µå±‚å‡ºä¸ç©·ï¼Œé˜²æŠ¤æ‰‹æ®µä¹Ÿéœ€è¦æŒç»­è¿›è¡Œå‡çº§åŠ å›ºã€‚é€šè¿‡å®‰å…¨å®¹å™¨æŠ€æœ¯æ¥ä½¿å¾—å®¹å™¨ç¯å¢ƒæ›´åŠ çš„å®‰å…¨ã€‚

</aside>

## gVisor
æ‰€çŸ¥ï¼Œå®¹å™¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—® Linux å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®¹å™¨åœ¨å®‰å…¨éš”ç¦»ä¸Šè¿˜æ˜¯æ¯”è¾ƒå¼±ï¼Œè™½ç„¶å†…æ ¸åœ¨ä¸æ–­åœ°å¢å¼ºè‡ªèº«çš„å®‰å…¨ç‰¹æ€§ï¼Œä½†ç”±äºå†…æ ¸è‡ªèº«ä»£ç æç«¯å¤æ‚ï¼ŒCVE æ¼æ´å±‚å‡ºä¸ç©·ã€‚  

æ‰€ä»¥è¦æƒ³å‡å°‘è¿™æ–¹é¢å®‰å…¨é£é™©ï¼Œå°±æ˜¯åšå¥½å®‰å…¨éš”ç¦»ï¼Œé˜»æ–­å®¹å™¨å†…ç¨‹åºå¯¹ç‰©ç†æœºå†…æ ¸çš„ä¾èµ–ã€‚ 

[gVisor](https://github.com/google/gvisor) æ˜¯ Google åœ¨ 2018 å¹´å¼€æºçš„ä¸€æ¬¾æ²™ç®±åŒ–çš„å®¹å™¨è¿è¡Œæ—¶è½¯ä»¶ï¼Œå®ƒæ˜¯ç”¨ Go è¯­è¨€ç¼–å†™çš„ï¼Œä¸»è¦çš„åŠŸèƒ½æ˜¯ä¸ºå®¹å™¨ç¯å¢ƒæä¾›ä¸€ä¸ªå®‰å…¨çš„éš”ç¦»ç¯å¢ƒï¼Œ éš”ç¦»å®¹å™¨å†…åº”ç”¨å’Œå†…æ ¸ä¹‹é—´è®¿é—®ï¼Œæä¾›äº†å¤§éƒ¨åˆ† Linux å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå·§å¦™çš„å°†å®¹å™¨å†…è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨è½¬åŒ–ä¸ºå¯¹ gVisor çš„è®¿é—®ã€‚ä½†åŒæ—¶ä¹Ÿä¼šå…¼é¡¾è½»é‡çº§ï¼Œä»¥åŠä¸ Docker å’Œ Kubernetes ç­‰äº‘åŸç”ŸåŸºç¡€è½¯ä»¶çš„é›†æˆã€‚

é€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯å’Œå®¹å™¨åŒ–æŠ€æœ¯çš„å¯¹æ¯”å¯ä»¥å¾—å‡ºä»¥ä¸‹æ¨æ–­ï¼šå¦‚æœå®¹å™¨æŠ€æœ¯å¯ä»¥å¢åŠ å…¶éš”ç¦»æ€§ï¼Œæˆ–è€…å‡å°‘å¯¹å†…æ ¸çš„å…±ç”¨ï¼Œé‚£ä¹ˆå¯¹äºé™ä½æ”»å‡»é¢è€Œè¨€æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼›ä¸æ­¤åŒæ—¶ï¼Œå¦‚æœè™šæ‹ŸåŒ–æŠ€æœ¯å¯ä»¥æ¶ˆè€—æ›´å°‘çš„èµ„æºï¼Œé‚£ä¹ˆä¸€å®šèƒ½æœ‰æ›´å¤§çš„å‘å±•ã€‚gVisor å°±æ˜¯è¿™ä¸ªæ¨æ–­çš„æœ€ä¸»è¦äº§ç‰©ä¹‹ä¸€ã€‚

gVisor å®é™…ä¸Šæ˜¯é€šè¿‡å®ç°äº†ä¸€ç»„å¯ä»¥ç”¨æ¥æ‹¦æˆªåº”ç”¨ç¨‹åºå¯¹ Linux å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹å’Œä»£ç†æ¥å·¥ä½œçš„ã€‚

1. gVisor çš„æœ€ç»ˆè¿è¡Œç¯å¢ƒæ˜¯ä¸€ä¸ªå—é™çš„ï¼Œä»…æä¾›éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨è®¿é—®çš„ç¯å¢ƒï¼Œæœ€ç»ˆå¯¹äºä¸»æœºä¸Šå†…æ ¸çš„å½±å“æˆ–è€…æ”»å‡»é¢æš´éœ²éƒ½æ˜¯å¯æ§çš„ï¼Œå—é™çš„
2.  å…¶æ¬¡ï¼Œåº”ç”¨ç¨‹åºå‘å‡ºçš„å„ç§ç³»ç»Ÿè°ƒç”¨è¯·æ±‚ï¼Œéƒ½æ˜¯ç”± gVisor è¿›è¡Œæ‹¦æˆªå’Œå¤„ç†çš„ï¼ŒgVisor éœ€è¦å»è¦†ç›–å„ç§ä¸åŒç±»å‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥å¯¹äºåº”ç”¨ç¨‹åºè€Œè¨€ï¼Œå…¼å®¹æ€§ä¹Ÿä¼šæ˜¯ä¸€ä¸ªé—®é¢˜
3. æœ€åå°±æ˜¯å…³äºæ€§èƒ½çš„é—®é¢˜ï¼ŒgVisor ç”±äºéƒ½æ˜¯è‡ªå·±å®ç°çš„ç³»ç»Ÿè°ƒç”¨çš„æ¨¡æ‹Ÿï¼Œæ‰€ä»¥åœ¨ç½‘ç»œæ€§èƒ½æ–¹é¢éœ€è¦æ³¨æ„ä¸€äº›ã€‚

### Ubuntu å®‰è£…ä½¿ç”¨ gVisor

ç”±äºä½¿ç”¨ CentOS éœ€è¦å‡çº§å†…æ ¸ï¼Œä½¿ç”¨ Ubuntu è¿›è¡Œå®‰è£…éƒ¨ç½²

```bash
sudo apt-get update && sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg
```

ç„¶åæ·»åŠ  gVisor çš„ APT æºï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨åŒ…ç®¡ç†å™¨ç›´æ¥è¿›è¡Œå®‰è£…äº†ã€‚*ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å›½å†…æ­¤åœ°å€è®¿é—®ä¸äº†ï¼Œéœ€è¦è‡ªè¡Œè§£å†³ç½‘ç»œé—®é¢˜ï¼‰*

```bash
# é…ç½®æº
curl -fsSL https://gvisor.dev/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main" | sudo tee /etc/apt/sources.list.d/gvisor.list > /dev/null

# å®‰è£…
sudo apt-get update && sudo apt-get install -y runsc
```

å®‰è£…æˆåŠŸåï¼ŒéªŒè¯å…¶ç‰ˆæœ¬ä¿¡æ¯

```bash
runsc -version

runsc version release-20220117.0
spec: 1.0.2-dev
```

å¦‚æœä¸€åˆ‡ç¡®è®¤æ­£å¸¸çš„è¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä¸º Docker æ·»åŠ é…ç½®äº†ï¼Œå¯ä»¥ç®€å•çš„æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå®ƒä¼šè‡ªåŠ¨çš„ä¸º Docker æ·»åŠ ä¸€ä¸ªé…ç½®ï¼Œå°† runsc æ³¨å†Œä¸º Docker çš„ä¸€ä¸ª runtime ã€‚

```bash
sudo runsc install
----
Added runtime "runsc" with arguments [] to "/etc/docker/daemon.json".

cat /etc/docker/daemon.json
----
{
    "runtimes": {
        "runsc": {
            "path": "/usr/bin/runsc"
        }
    }
}

sudo systemctl restart docker
```

æ¥ä¸‹æ¥ï¼ŒéªŒè¯ gVisor çš„æ•ˆæœã€‚å…¶å®æˆ‘ä»¬ä¹Ÿä¸éœ€è¦å¤ªå¤šå…¶ä»–çš„éªŒè¯ï¼Œè¿™é‡Œæ‰§è¡ŒÂ `uname -a` å¯ä»¥çœ‹åˆ°å½“å‰ä½¿ç”¨ gVisor runtime å¯åŠ¨çš„å®¹å™¨ï¼Œå…¶å†…æ ¸ç‰ˆæœ¬å·²ç»å˜æˆäº† v4.4ï¼Œè¯´æ˜ä¸å½“å‰ ä¸»æœºä¸Šçš„å†…æ ¸å·²ç»å®Œæˆäº†éš”ç¦»ã€‚

```bash
sudo docker run --runtime=runsc --rm -it alpine uname -a
----
Linux 0bf0cbbd258f 4.4.0 #1 SMP Sun Jan 10 15:06:54 PST 2016 x86_64 Linux
```

ä¹Ÿå¯ä»¥é€šè¿‡æ‰§è¡ŒÂ `dmesg`Â æ¥çœ‹åˆ°å…·ä½“çš„å¯åŠ¨ä¿¡æ¯ç­‰ã€‚

```bash
ubuntu@moelove2:~$ sudo docker run --runtime=runsc --rm -it alpine dmesg
[   0.000000] Starting gVisor...
[   0.485956] Gathering forks...
[   0.595006] Letting the watchdogs out...
[   0.885356] Moving files to filing cabinet...
[   1.251027] Checking naughty and nice process list...
[   1.424831] Adversarially training Redcode AI...
[   1.496378] Searching for needles in stacks...
[   1.540394] Generating random numbers by fair dice roll...
[   1.796710] Granting licence to kill(2)...
[   2.267870] Reticulating splines...
[   2.752975] Waiting for children...
[   3.060289] Setting up VFS2...
[   3.316167] Ready!
```

### CentOS 7 å®‰è£…ä½¿ç”¨ gVisor

å‡çº§ CentOS 7 å†…æ ¸

```bash
rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml â€“y
grub2-set-default 0
reboot
uname -r
```

å‡†å¤‡ gVisor äºŒè¿›åˆ¶æ–‡ä»¶

```bash
sha512sum -c runsc.sha512
rm -f *.sha512
chmod a+x runsc
mv runsc /usr/local/bin
```

Docker é…ç½®ä½¿ç”¨ gVisor

```
runsc install
# æŸ¥çœ‹åŠ çš„é…ç½®  /etc/docker/daemon.json
systemctl restart docker
```

ä½¿ç”¨ runsc è¿è¡Œå®¹å™¨

```bash
docker run -d --runtime=runsc nginx
# ä½¿ç”¨dmesgéªŒè¯
docker run --runtime=runsc -it nginx dmesg
```

[å·²ç»æµ‹è¯•è¿‡çš„åº”ç”¨å’Œå·¥å…·](https://gvisor.dev/docs/user_guide/compatibility/)

### gVisor ä¸ Containerd é›†æˆ

[åˆ‡æ¢ Containerd å®¹å™¨å¼•æ“]()

RuntimeClass æ˜¯ä¸€ä¸ªç”¨äºé€‰æ‹©å®¹å™¨è¿è¡Œæ—¶é…ç½®çš„å¯¹è±¡ï¼Œå®¹å™¨è¿è¡Œæ—¶é…ç½®ç”¨
äºè¿è¡Œ Pod ä¸­çš„å®¹å™¨ã€‚

åˆ›å»º RuntimeClass

```yaml
apiVersion: node.k8s.io/v1 # RuntimeClass å®šä¹‰äº node.k8s.io API ç»„
kind: RuntimeClass
metadata:
  name: gvisor # ç”¨æ¥å¼•ç”¨ RuntimeClass çš„åå­—
handler: runsc # å¯¹åº”çš„ CRI é…ç½®çš„åç§°
```

åˆ›å»º Pod æµ‹è¯• gVisor

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-gvisor
spec:
  runtimeClassName: gvisor
  containers:
  - name: nginx
    image: nginx
```

```bash
kubectl get pod nginx-gvisor -o wide
kubectl exec nginx-gvisor -- dmesg
```

gVisor ç¡®å®ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„å®‰å…¨è§£å†³æ€è·¯ï¼Œä½†æ˜¯ç”±äºå®ƒéœ€è¦å»å®ç°å„ç§ç³»ç»Ÿè°ƒç”¨ï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºé—´å¯èƒ½ä¼šå‡ºç°ä¸å…¼å®¹çš„æƒ…å†µã€‚

## **Kata Containers**

Kata Containers æ˜¯åœ¨ 2017 å¹´çš„æ—¶å€™ï¼Œç”± Intel çš„ Clear Container å’Œ HyperHQ çš„ runV é¡¹ç›®åˆå¹¶è€Œæ¥çš„ã€‚å®ƒå¹¶ä¸åƒä¸Šè¿°æåˆ°çš„ gVisor é‚£æ ·ï¼Œ é‡‡ç”¨"æ¨¡æ‹Ÿ"ç³»ç»Ÿè°ƒç”¨æˆ–è€…è¯´é˜»æ­¢ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼æ¥å®ç°ã€‚

Kata Containers æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç²¾ç®€åçš„è™šæ‹Ÿæœºï¼Œæ‰€ä»¥å®ƒå¹¶ä¸åƒ gVisor é‚£æ ·å¯èƒ½ä¼šå­˜åœ¨ä¸å…¼å®¹çš„é—®é¢˜ï¼Œä¹Ÿä¸ä¼šåƒä¸€èˆ¬çš„å®¹å™¨åŒ–æŠ€æœ¯é‚£æ ·ï¼Œç”±äºéœ€è¦å…±äº«ä¸»æœºçš„å†…æ ¸è€Œå¯èƒ½å¯¼è‡´çš„å®‰å…¨é—®é¢˜ï¼Œå¹¶ä¸”å®ƒè¿˜è¶³å¤Ÿçš„è½»é‡ã€‚æ‰€ä»¥å®ƒèƒ½ä¸ºæˆ‘ä»¬å¸¦æ¥ç±»ä¼¼è™šæ‹Ÿæœºé‚£æ ·çš„å®‰å…¨ï¼Œä¹ŸåŒæ—¶å¯ä»¥åƒå®¹å™¨ä¸€æ ·è¿…é€Ÿã€‚

ç›®å‰ Kata Containers æ”¯æŒå¤šç§ CPU æ¶æ„ï¼ŒåŒæ—¶ï¼Œç”±äºå®ƒè¿˜æ˜¯è™šæ‹Ÿæœºï¼Œå®ƒæ”¯æŒå¤šä¸ªç®¡ç†ç¨‹åºã€‚åŒ…æ‹¬ï¼šQEMU å’Œ Firecracker ç­‰ã€‚

[https://github.com/firecracker-microvm/firecracker](https://github.com/firecracker-microvm/firecracker)

<aside>
ğŸ’¡ è¿™é‡Œé¢å¤–è¡¥å……ä¸€ä¸‹Â Firecrackerï¼šå®ƒæ˜¯ç”± Amazon Web Services å¼€æºçš„ï¼Œä¸»è¦ç›®æ ‡æ˜¯ç”¨åˆ° AWS Lambda å’Œ AWS Fargate ç­‰ Serverless ç¯å¢ƒä¸­ï¼Œç”¨äºåŠ é€Ÿè¿™äº›æœåŠ¡çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚è¿™ä¸ªé¡¹ç›®ä¹Ÿéå¸¸çš„æ´»è·ƒï¼Œè¢«å¾ˆå¤šçš„å…¬å¸ä½œä¸º Serverless åœºæ™¯çš„æ ‡å‡†é€‰é¡¹ä¹‹ä¸€ã€‚

</aside>

å¯¹äº Kata Containers è€Œè¨€ï¼Œå®ƒä½¿ç”¨çš„æ˜¯ä¼ ç»Ÿçš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œé€šè¿‡åœ¨ç¡¬ä»¶å±‚æ¨¡æ‹Ÿå‡ºä¸€å°"è™šæ‹Ÿæœº"ï¼Œç„¶ååœ¨æ­¤è™šæ‹Ÿæœºä¸­å®‰è£…ä¸€ä¸ªè£å‡åçš„ Linux å†…æ ¸æ¥å®ç°å¼ºéš”ç¦»ã€‚

ç›¸æ¯”äº gVisor è€Œè¨€ï¼ŒKata Containers æ›´åŠ çš„é€‚åˆäº Kubernetes çš„ç¯å¢ƒï¼Œå› ä¸º Kubernetes ä¸­æœ€å°çš„è°ƒåº¦å•å…ƒæ˜¯ Podï¼Œå½“ä½¿ç”¨ gVisor çš„æ—¶å€™ï¼Œ å®ƒå¯¹äºå¤šå®¹å™¨çš„æ”¯æŒå¹¶ä¸å®Œå–„ã€‚ä½†æ˜¯ Kata Containers å®Œå…¨ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªï¼Œå®ƒæœ¬èº«æ˜¯ä¸ªè™šæ‹Ÿæœºï¼Œæ‰€ä»¥æ¯ä¸ª Pod éƒ½å¯ä»¥ç›´æ¥æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºä¸­ çš„è¿›ç¨‹å¤©ç„¶çš„å…±äº«å„ç§ Namespace , åªè¦å†é¢å¤–çš„å¼€å¯ Mount Namespace å³å¯ã€‚

[https://github.com/kata-containers/kata-containers](https://github.com/kata-containers/kata-containers)

## æ€»ç»“

æ— è®ºæ˜¯ gVisor è¿˜æ˜¯ Kata Containers å®ƒä»¬éƒ½æ˜¯ä¸ºå®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºä¸ä¸»æœºçš„æ“ä½œç³»ç»Ÿä¹‹é—´å¢åŠ äº†ä¸€å±‚éš”ç¦»ï¼Œ ä»è€Œé¿å…å®¹å™¨å…±äº«ä¸»æœºçš„å†…æ ¸ï¼Œä»¥æ­¤æ¥è§£å†³å®¹å™¨é€ƒé€¸çš„é—®é¢˜ï¼Œæˆ–è€…é€šè¿‡å®¹å™¨è·å–ä¸»æœºæ§åˆ¶æƒé™çš„é—®é¢˜ç­‰ã€‚

åœ¨å®‰å…¨å®¹å™¨è¿™ä¸€é¢†åŸŸï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šå…¶ä»–å»¶ä¼¸çš„é¡¹ç›®ï¼ŒåŒ…æ‹¬Â Weave IgniteÂ ç­‰é¡¹ç›®ï¼Œ éƒ½æ˜¯åœ¨æŒç»­çš„æ¢ç´¢å’Œå‰è¿›ã€‚

[https://github.com/weaveworks/ignite](https://github.com/weaveworks/ignite)

## æ‹“å±•é˜…è¯»

- gVisor æ€§èƒ½æŒ‡å—ï¼š [Performance Guide - gVisor](https://gvisor.dev/docs/architecture_guide/performance/)
- Kata Containers ä½¿ç”¨æŒ‡å—ï¼šÂ [Technical Documentation - Tech Docs - Kata Containers | Kata Containers](https://katacontainers.io/docs/)