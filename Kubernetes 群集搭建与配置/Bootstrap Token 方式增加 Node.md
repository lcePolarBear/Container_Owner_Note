## Bootstrap Token 方式增加 Node
---
### 准备新节点环境
1. 安装好 docker
2. 拷贝已部署好的 Node 相关文件到新节点 Node3
    ```bash
    scp -r /opt/kubernetes/ root@k8s-node3:/opt/
    scp -r usr/lib/systemd/system/{kubelet,kube-proxy}.service root@k8s-node3:/usr/lib/systemd/system
    scp -r /opt/cni/ root@k8s-node3:/opt
    ```
3. 删除 kubelet 证书和 kubeconfig 文件
    - 这几个文件是证书申请审批后自动生成的，每个 Node 不同，必须删除重新生成
    ```bash
    cd /opt/kubernetes/ssl/
    rm kubelet* -f
    cd  /opt/kubernetes/cfg/
    rm kubelet.kubeconfig bootstrap.kubeconfig -f
    ```
4. 修改 kubelet.conf , kube-proxy-config.yml 主机名
    ```bash
    # vi /opt/kubernetes/cfg/kubelet.conf
        --hostname-override=k8s-node3
    
    # vi /opt/kubernetes/cfg/kube-proxy-config.yml
        hostnameOverride: k8s-node3
    ```

### 确认启用 Bootstrap Token
```bash
# cat /opt/kubernetes/cfg/kube-apiserver.conf
    --enable-bootstrap-token-auth=true
```

### 使用 Secret 存储 Bootstrap Token
```bash
# vi bootstrap-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-07401b
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubeadm init'."
  token-id: 07401b
  token-secret: f395accd246ae52d
  expiration: 2021-03-10T03:22:11Z      # token过期时间
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
```
```bash
kubectl apply -f bootstrap-secret.yaml
```

### 创建 RBAC 角色绑定，允许 kubelet tls bootstrap 创建 CSR 请求
```bash
# vi rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: create-csrs-for-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
```
```
kubectl apply -f rbac.yaml
```

### kubelet 配置 Bootstrap kubeconfig 文件
1. 在 node3 上操作
    ```bash
    # vi /opt/kubernetes/cfg/bootstrap.kubeconfig

    apiVersion: v1
    kind: Config
    clusters:
    - cluster:
        certificate-authority: /opt/kubernetes/ssl/ca.pem
        server: https://192.168.31.61:6443
      name: bootstrap
    contexts:
    - context:
        cluster: bootstrap
        user: kubelet-bootstrap
      name: bootstrap
      current-context: bootstrap
      preferences: {}
      users:
      - name: kubelet-bootstrap
        user:
          token: 07401b.f395accd246ae52d 
    ```
2. 配置文件指定 kubeconfig 文件（默认已经配置）
    ```bash
    # cat /opt/kubernetes/cfg/kubelet.conf

    KUBELET_OPTS="--logtostderr=false \
    --v=4 \
    --log-dir=/opt/kubernetes/logs \
    --hostname-override=k8s-node3 \
    --kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \
    --bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig
    ```
3. 启动并设置开机启动
    ```
    systemctl daemon-reload
    systemctl start kubelet
    systemctl enable kubelet
    ```
### 在 Master 节点颁发证书
1. 查看节点添加请求
    ```
    kubectl get csr
    ```
2. 通过请求
    ```
    kubectl certificate approve xxx
    ```
3. 查看新节点
    ```
    kubectl get node
    ```