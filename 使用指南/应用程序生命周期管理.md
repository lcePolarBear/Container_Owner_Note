## 应用程序生命周期管理

__Kubernetes 中应用程序的部署流程__
1. 制作镜像 - `dockerfile`
2. 使用控制器部署镜像 - `Deployment | StatefulSet | DaemonSet`
3. 对外暴露应用
4. 日志、监控
5. 日常运维

__示例:使用 Deployment 部署 Java 应用__
1. 使用 Deployment 控制器部署镜像
    ```
    kubectl create deployment web --image=lizhenliang/java-demo
    kubectl get deploy,pods 
    ```
2. 使用 Service 发布Pod
    ```
    kubectl expose deployment web --port=80 --type=NodePort --target-port=8080 --name=web
    kubectl get service
    ```

__服务编排： YAML 文件创建资源对象__
- 使用 YAML 文件创建 Deployment
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx-deployment
      namespace: default
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx:1.19
            ports:
            - containerPort: 80
    ```
    - `apiVersion` : API 版本 `kubectl api-sersion` 查看最新版本
        ```
    - `kind` : 资源类型
    - `metadata` : 资源元数据
    - `spec` : 资源规格
    - `replicas` : 副本数量
    - `selector` : 标签选择器
    - `template` : Pod 模板
    - `metadata` : Pod 元数据
    - `spec` : Pod 规格
    - `containers` : 容器配置
- 使用 YAML 文件创建 Service
    ```yaml
    apiVersion: v1
    kind: Service
    metadata:
      name: nginx-deployment
    spec:
      selector:
        app: nginx
      ports:
        - protocol: TCP
          port: 80
          targetPort: 80
      type: NodePort
    ```
    - ports : 端口
    - selector : 标签选择器
    - type : Service 类型
- YAML 语法格式
    - 缩进表示层级关系
    - 不支持制表符 "tab" 缩进，使用空格缩进
    - 开头缩进 2 个空格
    - 冒号，横杠后面缩进 1 个空格
    - "---" 表示是下一个片段的开头
    - "#" 标识注释
- 导出 deployment 生成的 YAML
    - 用 create 命令生成 YAML
    ```
    kubectl create deployment nginx --image=nginx:1.16 -o yaml --dry-run=client > my-deploy.yaml
    ```
    - 用 get 命令生成 YAML
    ```
    kubectl get deployment nginx -o yaml > my-deploy.yaml
    ```

__应用升级、弹性伸缩、回滚、删除__
- 应用升级
    ```
    kubectl set image deployment/web nginx=nginx:1.19 --recode
    ```
    - 查看升级状态
        ```
        kubectl rollout status deployment/web
        ```
- 弹性伸缩
    - 手动扩容
        ```
        kubectl scale deployment web --replicas=10
        ```
    - 自动水平扩容（注意 Pod 必须配置 `resource.requests` ）
        ```
        kubectl autoscale deployment web --min=3 --max=10 --cpu-percent=80
        ```
    - 查看伸缩的状况
        ```
        kubectl get hpa
        ```
    - 尝试使用 `httpd-tools` 工具进行压测
        ```
        ab -n 100000 -c 1000 http://{cluster-ip}/index.html
        ```
- 回滚
    ```
    kubectl rollout history deployment/web                  # 查看更新记录
    kubectl rollout undo deployment/web                     # 回滚上一个版本
    kubectl rollout undo deployment/web --to-revision=2     # 回滚指定版本
    ```
- 删除
    ```
    kubectl delete deploy/web
    kubectl delete svc/web
    ```
- 滚动升级与回滚机制
    - ReplicaSet : 副本集
        - Pod 副本数量管理，不断对比当前 Pod 数量与期望 Pod 数量
        - Deployment 每次发布都会创建一个 RS 作为记录，用于实现回滚
        ```
        kubectl get rs  # 查看 RS 记录 
        kubectl rollout history deployment web  # 版本对应 RS 记录
        ```